<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>index page</title>
</head>
<link rel="stylesheet" href="https://www.layuicdn.com/layui-v2.5.7/css/layui.css">
<script type="text/javascript" src="https://www.layuicdn.com/layui-v2.5.7/layui.js"></script>
<!--<link rel="stylesheet" href="./layui/css/layui.css">-->
<!--<script type="text/javascript" src="./layui/layui.js"></script>-->
<body>
<div class="layui-container">
    <div class="layui-tab" lay-filter="tab">
        <ul class="layui-tab-title">
            <li class="layui-this" lay-id="news">今日热点</li>
            <li lay-id="2">用户管理</li>
            <li lay-id="3">权限分配</li>
            <li lay-id="4">商品管理</li>
            <li lay-id="5">订单管理</li>
        </ul>
        <div class="layui-tab-content">
            <div class="layui-tab-item layui-show">
                <button id="fre">点击刷新</button>
                <div id="news-list"></div>
            </div>

            <div class="layui-tab-item">内容2</div>
            <div class="layui-tab-item">内容3</div>
            <div class="layui-tab-item">内容4</div>
            <div class="layui-tab-item">内容5</div>
        </div>
    </div>
</div>
</body>

<script type="text/javascript">

    window.addEventListener('pywebviewready', function () {
        // pywebview.api.show_tips().then(response => {
        //     alert(response)
        // })
        // alert("pywebview is ok")
        // var current_tab = "news";
        var init = 0

        layui.use(['element', 'jquery', 'layer'], function () {
            var $ = layui.$;
            var element = layui.element;
            var layer = layui.layer;


            loadCacheTab();
            //监听Tab切换，以改变地址hash值
            element.on('tab(tab)', function () {
                let id = this.getAttribute('lay-id');
                // alert(id)
                // if (id == 'news') {
                //     loadNewsData();
                // }
                if (init == 0) {
                    if (id == 'news') {
                        loadNewsData();
                        init++
                    }
                }
                saveCacheTab(id)

            });

            document.getElementById("fre").onclick = function () {
                loadNewsData();
            };

            function loadCacheTab() {
                pywebview.api.load_cache().then(response => {
                    if (response) {
                        let current_tab = response.current_tab;
                        element.tabChange('tab', current_tab)
                    }
                })
            }

            function saveCacheTab(tab_id) {
                pywebview.api.save_cache(tab_id).then(response => {

                })
            }

            function loadNewsData() {
                // alert("click")
                pywebview.api.load_news().then(response => {
                    if (response.errno != 0) {
                        layer.msg(response.errmsg);
                        return false;
                    }
                    $("#news-list").html('')
                    data = response.data;
                    $.each(data.top, function (index, item) {
                        $("#news-list").append(`
                            <div class="layui-card">
                                <div class="layui-card-body">
                                  <strong style="font-size: large"><i class="layui-badge">热点</i><a title="浏览器中打开" target="_blank" href="` + item.display_url + `">` + item.abs + ` </a></strong>
                                  <div class="layui-text">` + item.site + `</div>
                                </div>
                            </div>
                            `)
                    });

                    $.each(data.news, function (index, item) {
                        $("#news-list").append(`
                            <div class="layui-card">
                                <div class="layui-card-body">
                                  <strong style="font-size: large"><a title="浏览器中打开" target="_blank" href="` + item.display_url + `">` + item.abs + ` </a></strong>
                                  <div class="layui-text">` + item.site + `</div>
                                </div>
                            </div>
                            `)
                    });
                })
            }
        });
    })
</script>
</html>